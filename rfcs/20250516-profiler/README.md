# OneCCL Profiler Design Document (RFC)

## Introduction / Motivation
oneCCL currently provides features such as info and debug logs
under CCL_LOG_LEVEL, and traces under CCL_ITT_LEVEL. They provide
detailed information, which require navigating through verbose logs
or using external tools for analysis. Despite these tools, there
is need and room for an in-built profiler in oneCCL, which provides
concise information and will not depend on advanced external tools
for analysis.

In this document, we propose a new in-built profiler for oneCCL to
address such needs.

## Request for feedback
The presented profiler is a work in progress and we want community
feedback to help drive the direction.
Feedback is welcome for the areas such as what information to
capture, the output format, comments on the presented ideas, or
any other relevant topics.

## Proposal

The proposed profiler will capture runtime information from
oneCCL that will help understand the runtime configurations and
the application communication pattern. Specifically, it will
capture:
a) CCL environment information, and
b) CCL API call information.

### CCL environment information

CCL environment information includes information such as the CCL
library version, compute backend, compiler, runtime environment
variables, and OFI provider. These information help understand
the runtime configuration of the applications.

The following text shows example of the environment info. Here,
each line has preceding Profiling_env to identify the lines.
Note that the format is subject to change.
```
2025:05:01-12:16:24:(1407613) |Profiling_env| CCL_WORKER_COUNT: 1
2025:05:01-12:16:24:(1407613) |Profiling_env| CCL_WORKER_OFFLOAD: 1
2025:05:01-12:16:24:(1407613) |Profiling_env| CCL_WORKER_WAIT: 1
2025:05:01-12:16:24:(1407613) |Profiling_env| CCL_LOG_LEVEL: warn
```

### CCL API call information
The API call information captures the communication behavior of
the application. It is generated by profiling communication operations
such as:
the collectives (allreduce, allgather, allgatherv, alltoall,
alltoallv, barrier, broadcast, reduce, reduce_scatter),
point to point  operations (send and recv), and possibly more
API calls such as the Group APIs.

The information is collected on a per communicator basis and
captures the following information:
1) Basic information such as:
    - user arguments for the API calls,
    - communicator ID,
    - rank
2) Runtime information such as:
    - operation count/API calls with a unique set of arguments
and communicator ID.
    - the host time consumed by the API calls with same user
arguments and communicator ID,  and
    - possibly kernel execution time
3) Algorithm related states such as:
    - usage rate of a certain buffers,
    - alignment of the user data buffer.

Here we show example with a simple CSV format. This example
shows the profiling header and a sample output for allgatherv and allreduce.
Output is printed with preceding Profiling_Header and Profiling_log,
which can help filter out the profiling information during analysis.

```
Profiling_Header:, operation, comm_id, rank, comm_size, msg_count, datatype, op_count, [duration-us;*].
Profiling_log:,allgatherv,1,0,12,9,float64,34,[262;96;105;95;99;93;104;88;99;96;113;83;106;83;143;91;112;90;115;91;133;101;104;76;168;96;206;108;253;104;222;89;260;99;]
Profiling_log:,allreduce_sum,7,0,12,128,float32,5,[31;10;9;8;8;]
```

### Output Format
By default, the profiling summary is printed at the end of the application.
It includes the environment information followed by the communication API
profiling info. There can be multiple options to format the output of
the communication API profiling info. One option is comma separated values (CSV).

A way to version the output formatting may also be useful to inform the
tools that consume or process the profiling output.

NOTE: the output formatting is a good candidate where the community
feedback will be valuable.

### User knobs

#### `CCL_PROFILING_ENABLE=<value>`
| \<value> | Description |
|---------|-------------------------------------|
| 1       | Enable oneCCL profiling.            |
| 0       | Disable oneCCL profiling (default). |

This env enables/disables the profiler for the lifetime of the application.


#### `CCL_PROFILING_ENABLED_RANKS=<value>`
| \<value>      | Description                                         |
|---------------|-----------------------------------------------------|
| -1            | Profile all ranks                                   |
| ranks list    | Profile only the ranks from the list                |

Note: ranks list is formatted as comma separated list of ranks or rank range.
For instance, CCL_PROFILING_ENABLED_RANKS="0,4,8-12"

#### `Start/Stop API`
Proposed APIs:
| \<Name> | Description |
|---------|------------------------------------------------|
| `ccl_profiler_start()`       | Enable profiling          |
| `ccl_profiler_stop()`        | Disable oneCCL profiling  |

These APIs provide options for applications to enable/disable
the profiler in one or multiple source code sections. This
removes the limitation to enable/disable the profiler for
the complete  execution lifetime. This can help focus on
selected areas of the application.

#### Fine grain toggle knob:
These knobs allow enabling/disabling sub-features, for instance,
toggle profiling of the host time, kernel times, and other information
that the profiler will support.

Proposed env:
`CCL_ENABLE_PROFILING_<feature>=<value>`

`<feature>` examples: host_time, kernel_time

| \<value> | Description |
|---------|-----------------------------------|
| 1       | Enable the indicated feature      |
| 0       | Disable the indicated feature     |

Such fine grain filtering can help control the overhead involved
with collecting certain information or the verbosity of the
generated outputs.

#### `CCL_PROFILING_PRINT_ON_THE_FLY=<value>`
| \<value> | Description |
|---------|------------------------------------------------|
| 1       | Print the profiling info in real time          |
| 0       | Do not print the profiling info in real time   |

#### `CCL_PROFILING_OUTPUT=<value>`
| \<value> | Description |
|---------|------------------------------------------------|
| path    | When set, output is redirected to files in the |
|         | specified path, instead of stdout              |


## Additional capabilities under consideration
Here are some additional profiler capabilities that are under
consideration:
- Capture time for the initialization steps, for instance comm
creation time,
- Provide user knob for multiple levels of output verbosity,
- Possibly provide multiple selectable options for the output
format.

## Tech Preview
The 2021.16 release of oneCCL provides a technical preview of
this profiling feature under development. However, please note
that all aspects of this feature from the tech preview are
subject to change. There is no guarantee that the output
format will remain stable and should not yet be relied upon.
The feature may be removed without notice. The profiler
captures environment information and oneCCL communication
API call information. Only a single knob
`CCL_PROFILING_ENABLE` is provided.
